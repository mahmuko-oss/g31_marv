<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Group 31 MARV Control</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #ffdde1, #ee9ca7);
      color: #4a0033;
      text-align: center;
      padding: 20px;
    }
    h1 { color: #b30059; }

    button {
      background: #ff4da6;
      border: none;
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      transition: 0.3s;
    }
    button:hover { background: #e60073; }

    .tab-container { margin-top: 20px; }
    .tab-buttons { margin-bottom: 10px; }
    .tab-buttons button { background: #ff99cc; }

    .tab-content {
      display: none;
      border-radius: 12px;
      background: #ffe6f0;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .active { display: block; }

    .diag-item { margin: 10px 0; font-weight: bold; }
    .sensor { font-size: 20px; margin: 0 5px; }
    .W { color: gray; }
    .R { color: red; }
    .G { color: green; }
    .B { color: blue; }
    .K { color: black; }

    #logBox {
      text-align: left;
      background: white;
      padding: 10px;
      border-radius: 8px;
      height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 13px;
      border: 1px solid #ccc;
      white-space: pre;
    }

    #exportControls { margin-top: 10px; }
    #exportControls input { margin: 0 5px; }

    #toneCanvas {
      background: white;
      border: 1px solid #aaa;
      border-radius: 8px;
      width: 90%;
      height: 200px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <h1>Group 31 MARV Control</h1>
  <button id="connectBtn">üîó Connect via Bluetooth</button>
  <button id="touchBtn">üëâ Touch Button</button>

  <!-- Tabs -->
  <div class="tab-container">
    <div class="tab-buttons">
      <button onclick="openTab('displayTab')">üìä Display</button>
      <button onclick="openTab('logsTab')">üìù Logs</button>
    </div>

    <!-- DISPLAY TAB -->
    <div id="displayTab" class="tab-content active">
      <h2>Critical Systems Display</h2>
      <div class="diag-item">Sensor Colours: 
        <span id="s1" class="sensor">-</span>
        <span id="s2" class="sensor">-</span>
        <span id="s3" class="sensor">-</span>
      </div>
      <div class="diag-item">System State: <span id="state">IDLE</span></div>
      <div class="diag-item">Last Rotation: <span id="rotation">0¬∞</span></div>
      <div class="diag-item">Wheel Speeds: <span id="speeds">0 / 0 mm/s</span></div>
      <div class="diag-item">Distance: <span id="distance">0 mm</span></div>
      <div class="diag-item">Incidence Angle: <span id="angle">0¬∞</span></div>

      <!-- Live tone diagnostics -->
      <div class="diag-item">Tone Voltage: <span id="micVolt">0.00 V</span></div>
      <!-- <div class="diag-item">Pure Tone Status: <span id="toneStatus" style="color:red">‚ùå Not Detected</span></div> -->
      <hr style="margin:15px 0;">
<h3>Pure Tone Debug Info</h3>
<div class="diag-item">Tone ON flag: <span id="toneOn">0</span></div>
<div class="diag-item">Detected flag: <span id="toneDetected">0</span></div>
<div class="diag-item">Tone Duration: <span id="toneDuration">0 ms</span></div>
<div class="diag-item">Last Change: <span id="lastChange">0 ms</span></div>
<div class="diag-item">FSM State: <span id="fsmState">0</span></div>

      <!-- Oscilloscope-style live plot -->
      <canvas id="toneCanvas"></canvas>
    </div>

    <!-- LOGS TAB -->
    <div id="logsTab" class="tab-content">
      <h2>Raw Packet Logs</h2>
      <div id="logBox"></div>
      <div id="exportControls">
        <label>From: <input type="date" id="fromDate"></label>
        <label>To: <input type="date" id="toDate"></label>
        <button onclick="exportLogs()">‚¨á Export Logs</button>
        <button onclick="clearLogs()">üóë Clear Logs</button>
      </div>
    </div>
  </div>

  <script>
    let device, server, service;
    let txCharacteristic, rxCharacteristic;
    let logs = [];
    let qsCounter = 0;

    const colourMap = {0:'W',1:'R',2:'G',3:'B',4:'K'};

    // Tab switching
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
    }

    // Bluetooth connect
    document.getElementById("connectBtn").addEventListener("click", async () => {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: "MARV-ESP32" }],
          optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
        });
        server = await device.gatt.connect();
        service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
        txCharacteristic = await service.getCharacteristic("6e400003-b5a3-f393-e0a9-e50e24dcca9e");
        rxCharacteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e");
        await txCharacteristic.startNotifications();
        txCharacteristic.addEventListener("characteristicvaluechanged", handlePacket);
        alert("‚úÖ Connected to ESP32 MARV");
      } catch (err) {
        console.error(err);
        alert("‚ùå Connection failed: " + err);
      }
    });

    // Touch button
    document.getElementById("touchBtn").addEventListener("click", async () => {
      if (rxCharacteristic) {
        const data = new Uint8Array([0x01]);
        await rxCharacteristic.writeValue(data);
        addLog("Touch command sent");
      } else alert("Connect first!");
    });

    // Log helper
    function addLog(text) {
      qsCounter++;
      const ts = new Date().toLocaleString("en-GB", {hour12:false});
      const entry = `#${qsCounter} | ${ts}\n${text}\n`;
      logs.push({time: new Date(), text: entry});
      const logBox = document.getElementById("logBox");
      logBox.innerText = logs.map(l => l.text).join("\n");
      logBox.scrollTop = logBox.scrollHeight;
    }

    // Voltage graph setup
    const canvas = document.getElementById("toneCanvas");
    const ctx = canvas.getContext("2d");
    let toneData = [];
    const maxPoints = 100; // 100 samples on screen

    function drawGraph() {
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;
      ctx.clearRect(0,0,w,h);

      // Axis
      ctx.strokeStyle = "#ddd";
      ctx.beginPath();
      ctx.moveTo(0, h/2);
      ctx.lineTo(w, h/2);
      ctx.stroke();

      if (toneData.length < 2) return;

      ctx.strokeStyle = "#b30059";
      ctx.beginPath();
      for (let i=0; i<toneData.length; i++) {
        const x = (i / (maxPoints-1)) * w;
        const y = h - (toneData[i] / 3.3) * h; // scale 0‚Äì3.3V
        if (i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      requestAnimationFrame(drawGraph);
    }
    drawGraph();

    // BLE handler
    function handlePacket(event) {
      const value = new TextDecoder().decode(event.target.value);
      try {
        const data = JSON.parse(value);

        // üî∏ Tone updates
        if (data.mic_volt !== undefined) {
          document.getElementById("micVolt").innerText = data.mic_volt.toFixed(2) + " V";
          toneData.push(data.mic_volt);
          if (toneData.length > maxPoints) toneData.shift();
        }
        // ----- Extended Debug Info -----
if (data.tone_on !== undefined)
  document.getElementById("toneOn").innerText = data.tone_on;
if (data.pure_detected !== undefined)
  document.getElementById("toneDetected").innerText = data.pure_detected;
if (data.tone_duration !== undefined)
  document.getElementById("toneDuration").innerText = data.tone_duration + " ms";
if (data.last_change !== undefined)
  document.getElementById("lastChange").innerText = data.last_change + " ms ago";
if (data.current_state !== undefined)
  document.getElementById("fsmState").innerText = data.current_state;

        // ----- Extended Debug Info -----
if (data.tone_on !== undefined)
  document.getElementById("toneOn").innerText = data.tone_on;
if (data.pure_detected !== undefined)
  document.getElementById("toneDetected").innerText = data.pure_detected;
if (data.tone_duration !== undefined)
  document.getElementById("toneDuration").innerText = data.tone_duration + " ms";
if (data.tone_gap !== undefined)
  document.getElementById("lastChange").innerText = data.tone_gap + " ms gap";
if (data.current_state !== undefined)
  document.getElementById("fsmState").innerText = data.current_state;

        // üî∏ Full diagnostic packets
        if (data.S1 !== undefined) {
          updateSensor("s1", data.S1);
          updateSensor("s2", data.S2);
          updateSensor("s3", data.S3);
          document.getElementById("state").innerText = ["IDLE","CAL","MAZE","SOS"][data.state] || data.state;
          document.getElementById("rotation").innerText = data.rotation + "¬∞";
          document.getElementById("speeds").innerText = data.speedL + " / " + data.speedR + " mm/s";
          document.getElementById("distance").innerText = data.distance + " mm";
          document.getElementById("angle").innerText = data.angle + "¬∞";

          addLog(`Sensors: ${document.getElementById("s1").innerText} | ${document.getElementById("s2").innerText} | ${document.getElementById("s3").innerText}
State: ${document.getElementById("state").innerText}
Rotation: ${data.rotation}¬∞
Speeds: ${data.speedL} / ${data.speedR}
Distance: ${data.distance}
Angle: ${data.angle}
Voltage: ${document.getElementById("micVolt").innerText}
Tone: ${document.getElementById("toneStatus").innerText}`);
        }
      } catch (e) {
        console.warn("Non-JSON packet ignored:", value);
      }
    }

    // Export logs
    function exportLogs() {
      const fromDateStr = document.getElementById("fromDate").value;
      const toDateStr = document.getElementById("toDate").value;
      let filtered = logs;
      if (fromDateStr) {
        const from = new Date(fromDateStr);
        filtered = filtered.filter(l => l.time >= from);
      }
      if (toDateStr) {
        const to = new Date(toDateStr);
        to.setHours(23,59,59,999);
        filtered = filtered.filter(l => l.time <= to);
      }
      const blob = new Blob([filtered.map(l=>l.text).join("\n")], {type:"text/plain"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "marv_logs.txt";
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // Clear logs
    function clearLogs() {
      if (confirm("‚ö†Ô∏è Clear ALL logs?")) {
        logs = [];
        qsCounter = 0;
        document.getElementById("logBox").innerText = "";
      }
    }

    function updateSensor(id, code) {
      const letter = colourMap[code] || "-";
      const el = document.getElementById(id);
      el.innerText = letter;
      el.className = "sensor " + letter;
    }
  </script>
</body>
</html>



